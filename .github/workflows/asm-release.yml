# NeoMind WASM Extensions - Automated Release Workflow
#
# This workflow builds WASM extensions when a version tag is pushed.
# WASM extensions compile once and run on all platforms!

name: Build WASM Extensions

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build asm-hello extension
        run: |
          cd extensions/as-hello
          npm install
          npm run build

      - name: Verify WASM output
        run: |
          WASM_FILE=$(find extensions/as-hello/build -name "as-hello.wasm" | head -1)
          if [ -z "$WASM_FILE" ]; then
            echo "Error: WASM file not found!"
            find extensions/as-hello/build -type f
            exit 1
          fi
          echo "WASM file found: $WASM_FILE"
          ls -lh "$WASM_FILE"

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Prepare release artifacts
        run: |
          mkdir -p release
          WASM_FILE=$(find extensions/as-hello/build -name "as-hello.wasm" | head -1)
          # Create extension directory
          mkdir -p "as-hello"
          cp "$WASM_FILE" "as-hello/as-hello.wasm"
          cp extensions/as-hello/metadata.json "as-hello/as-hello.json"
          echo "Extension files:"
          ls -lh as-hello/

      - name: Calculate SHA256 checksums
        run: |
          cd release
          sha256sum as-hello/as-hello.wasm | awk '{print $1}' > as-hello/as-hello.wasm.sha256
          WASM_SHA=$(cat as-hello/as-hello.wasm.sha256)
          echo "WASM SHA256: $WASM_SHA"
          sha256sum as-hello/as-hello.json | awk '{print $1}' > as-hello/as-hello.json.sha256
          JSON_SHA=$(cat as-hello/as-hello.json.sha256)
          echo "JSON SHA256: $JSON_SHA"
          cat > checksums.txt << 'EOF'
          # SHA256 Checksums - WASM Extensions
          # Generated from GitHub Actions
          $WASM_SHA  as-hello/as-hello.wasm
          $JSON_SHA  as-hello/as-hello.json
          EOF
          mv checksums.txt as-hello/
          echo "Extension package:"
          ls -lh as-hello/

      - name: Create extension package
        run: |
          cd release
          tar -czvf as-hello-${{ steps.version.outputs.tag }}.tar.gz as-hello/
          echo "Created package:"
          ls -lh *.tar.gz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.tar.gz
          generate_release_notes: true
          draft: false
          prerelease: false
          name: ${{ steps.version.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## WASM Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Released Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh release/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
