# NeoMind WASM Extensions - Automated Release Workflow
#
# This workflow builds WASM extensions when a version tag is pushed.
# Dynamically detects and builds all WASM extensions in the extensions/ directory.

name: Build WASM Extensions

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find WASM extensions
        id: find-extensions
        run: |
          # Find all directories with package.json (WASM extensions)
          EXTENSIONS=""
          for dir in extensions/*/; do
            if [ -f "$dir/package.json" ]; then
              EXT_NAME=$(basename "$dir")
              if [ -n "$EXTENSIONS" ]; then
                EXTENSIONS="$EXTENSIONS,$EXT_NAME"
              else
                EXTENSIONS="$EXT_NAME"
              fi
            fi
          done
          echo "extensions=$EXTENSIONS" >> $GITHUB_OUTPUT
          echo "Found WASM extensions: $EXTENSIONS"

      - name: Build all WASM extensions
        run: |
          EXTENSIONS="${{ steps.find-extensions.outputs.extensions }}"
          if [ -z "$EXTENSIONS" ]; then
            echo "No WASM extensions found!"
            exit 1
          fi

          # Build each extension
          for EXT in ${EXTENSIONS//,/ }; do
            echo "================================"
            echo "Building extension: $EXT"
            echo "================================"
            cd "extensions/$EXT"
            npm install
            npm run build
            cd ../..
          done

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Prepare release artifacts
        run: |
          EXTENSIONS="${{ steps.find-extensions.outputs.extensions }}"
          mkdir -p release

          # Process each extension
          for EXT in ${EXTENSIONS//,/ }; do
            echo "Packaging extension: $EXT"

            # Find WASM file
            WASM_FILE=$(find "extensions/$EXT/build" -name "$EXT.wasm" -o -name "*.wasm" | head -1)
            if [ -z "$WASM_FILE" ]; then
              echo "Warning: WASM file not found for $EXT"
              continue
            fi

            # Create extension directory
            EXT_DIR="release/$EXT"
            mkdir -p "$EXT_DIR"

            # Copy WASM file with standardized name
            cp "$WASM_FILE" "$EXT_DIR/$EXT.wasm"

            # Copy metadata if exists
            if [ -f "extensions/$EXT/metadata.json" ]; then
              cp "extensions/$EXT/metadata.json" "$EXT_DIR/$EXT.json"
            fi

            echo "  Packaged: $EXT"
            ls -lh "$EXT_DIR"
          done

          echo ""
          echo "All packages:"
          ls -lh release/

      - name: Calculate SHA256 checksums
        run: |
          cd release

          # Calculate checksums for each extension
          for EXT_DIR in */; do
            echo "Calculating checksums for $EXT_DIR"

            # WASM file checksum
            if [ -f "$EXT_DIR/$EXT_DIR.wasm" ]; then
              WASM_SHA=$(sha256sum "$EXT_DIR/$EXT_DIR.wasm" | awk '{print $1}')
              echo "$WASM_SHA  $EXT_DIR.wasm" > "$EXT_DIR/$EXT_DIR.wasm.sha256"
              echo "    WASM: $WASM_SHA"
            fi

            # JSON file checksum
            if [ -f "$EXT_DIR/$EXT_DIR.json" ]; then
              JSON_SHA=$(sha256sum "$EXT_DIR/$EXT_DIR.json" | awk '{print $1}')
              echo "$JSON_SHA  $EXT_DIR.json" > "$EXT_DIR/$EXT_DIR.json.sha256"
              echo "    JSON: $JSON_SHA"
            fi

            # Create checksums.txt for this extension using printf (avoid heredoc issues)
            printf "# SHA256 Checksums\n# Generated from GitHub Actions\n" > "$EXT_DIR/checksums.txt"
            if [ -f "$EXT_DIR/$EXT_DIR.wasm.sha256" ]; then
              printf "%s\n" "$(cat $EXT_DIR/$EXT_DIR.wasm.sha256)" "$EXT_DIR.wasm" >> "$EXT_DIR/checksums.txt"
            fi
            if [ -f "$EXT_DIR/$EXT_DIR.json.sha256" ]; then
              printf "%s\n" "$(cat $EXT_DIR/$EXT_DIR.json.sha256)" "$EXT_DIR.json" >> "$EXT_DIR/checksums.txt"
            fi
          done

          echo ""
          echo "All packages with checksums:"
          find . -name "checksums.txt" -exec sh -c 'echo "{}:" && cat {}' \;

      - name: Create extension packages
        run: |
          cd release
          VERSION="${{ steps.version.outputs.tag }}"

          # Create tar.gz for each extension
          for EXT_DIR in */; do
            echo "Packaging $EXT_DIR..."
            tar -czvf "$EXT_DIR-$VERSION.tar.gz" "$EXT_DIR"
          done

          echo ""
          echo "Created packages:"
          ls -lh *.tar.gz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.tar.gz
          generate_release_notes: true
          draft: false
          prerelease: false
          name: ${{ steps.version.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## WASM Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Released Extensions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh release/*.tar.gz >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
