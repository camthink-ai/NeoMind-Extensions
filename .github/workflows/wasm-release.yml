# NeoMind WASM Extensions - Automated Release Workflow
#
# This workflow builds WASM extensions when a version tag is pushed.
# WASM extensions compile once and run on all platforms!
#
# Usage:
#   git tag v0.1.0
#   git push origin v0.1.0
#
# The workflow will automatically:
#   1. Build WASM extensions
#   2. Calculate SHA256 checksums
#   3. Create a GitHub Release
#   4. Upload WASM files + JSON metadata

name: Release WASM Extensions

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0'

permissions:
  contents: write

jobs:
  build-wasm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1

      - name: Verify WASM target
        run: |
          rustup target list | grep wasm
          rustc --print target-list | grep wasm32-unknown

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: wasm-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: wasm-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: wasm-cargo-build-wasm32-unknown

      - name: Build wasm-hello extension
        run: |
          cd extensions/wasm-hello
          cargo build --release --target wasm32-wasip1
          echo "Build complete:"
          find target -name "*.wasm" -exec ls -lh {} \;

      - name: Verify WASM output
        run: |
          WASM_FILE=$(find extensions/wasm-hello/target -name "wasm_hello.wasm" | head -1)
          if [ -z "$WASM_FILE" ]; then
            echo "Error: WASM file not found!"
            find extensions/wasm-hello/target -type f
            exit 1
          fi
          echo "WASM file found: $WASM_FILE"
          ls -lh "$WASM_FILE"
          file "$WASM_FILE"

      - name: Prepare release artifacts
        run: |
          mkdir -p release

          # Find and copy WASM file
          WASM_FILE=$(find extensions/wasm-hello/target -name "wasm_hello.wasm" | head -1)
          cp "$WASM_FILE" release/wasm_hello.wasm

          # Copy JSON metadata
          cp extensions/wasm-hello/wasm-hello.json release/wasm-hello.json

          echo "Release artifacts:"
          ls -lh release/

      - name: Calculate SHA256 checksums
        run: |
          cd release

          # SHA256 for WASM file
          sha256sum wasm_hello.wasm | awk '{print $1}' > wasm_hello.wasm.sha256
          WASM_SHA=$(cat wasm_hello.wasm.sha256)
          echo "WASM SHA256: $WASM_SHA"

          # SHA256 for JSON file
          sha256sum wasm-hello.json | awk '{print $1}' > wasm-hello.json.sha256
          JSON_SHA=$(cat wasm-hello.json.sha256)
          echo "JSON SHA256: $JSON_SHA"

          # Create checksums.txt
          cat > checksums.txt << EOF
          # SHA256 Checksums - WASM Extensions
          # Generated from GitHub Actions

          $WASM_SHA  wasm_hello.wasm
          $JSON_SHA  wasm-hello.json
          EOF

          cat checksums.txt
          cp checksums.txt ../

      - name: Generate release notes
        run: |
          cat > release_notes.md << 'EOF'
          ## WASM Extensions v{{ version }}

          ### What's Included

          **wasm-hello**: A simple WASM extension demonstrating cross-platform compatibility

          ### Installation

          **Method 1: NeoMind Marketplace**
          1. Open NeoMind Web UI
          2. Navigate to Extensions → Marketplace
          3. Find "WASM Hello Extension"
          4. Click Install

          **Method 2: Manual Installation**
          ```bash
          # Download both files
          wget https://github.com/camthink-ai/NeoMind-Extensions/releases/download/v{{ version }}/wasm_hello.wasm
          wget https://github.com/camthink-ai/NeoMind-Extensions/releases/download/v{{ version }}/wasm-hello.json

          # Install
          mkdir -p ~/.neomind/extensions
          cp wasm_hello.wasm ~/.neomind/extensions/
          cp wasm-hello.json ~/.neomind/extensions/
          ```

          ### WASM Advantages

          - ✅ Single binary for all platforms (macOS ARM64, macOS x64, Linux, Windows)
          - ✅ Sandboxed execution
          - ✅ Small file size (< 5KB)
          - ✅ No need to recompile for each platform

          ### Verification

          Verify downloads with SHA256:
          ```bash
          sha256sum -c checksums.txt
          ```

          ---

          ### Commands

          - `get_counter` - Get the current counter value
          - `increment_counter` - Increment the counter
          - `get_temperature` - Get temperature reading (simulated)
          - `get_humidity` - Get humidity reading (simulated)
          - `hello` - Say hello from WASM

          ### Metrics

          - `counter` - Counter value
          - `temperature` - Temperature in Celsius
          - `humidity` - Humidity percentage
          EOF

          cat release_notes.md

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG=${{ github.event.inputs.version }}
          else
            TAG=${GITHUB_REF#refs/tags/}
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Update release notes with version
        run: |
          sed -i "s/{{ version }}/${{ steps.version.outputs.version }}/g" release_notes.md

      - name: Copy files for release
        run: |
          mkdir -p release-final
          cp release/* release-final/
          cp checksums.txt release-final/
          cp release_notes.md release-final/
          ls -lh release-final/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-final/*
          body_path: release-final/release_notes.md
          draft: false
          prerelease: false
          name: ${{ steps.version.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## WASM Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Released Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh release-final/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
